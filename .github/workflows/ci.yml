name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:
    
jobs:
  # ──────────────────────────────────────────────
  # 1. Сборка бэкенда (.NET 9)
  # ──────────────────────────────────────────────
  build-backend:
    name: Сборка бэкенда
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Установка .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Восстановление зависимостей
        run: dotnet restore src/Project.HttpServer/Project.HttpServer.csproj

      - name: Сборка бэкенда (без тестовых проектов)
        run: dotnet build src/Project.HttpServer/Project.HttpServer.csproj --configuration Release --no-restore

  # ──────────────────────────────────────────────
  # 2. Тесты сервисов
  # ──────────────────────────────────────────────
  test-services:
    name: Тесты сервисов
    runs-on: ubuntu-latest
    needs: build-backend

    steps:
      - uses: actions/checkout@v4

      - name: Установка .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Поиск проекта сервисных тестов
        run: |
          SERVICE_TESTS_PROJECT="$(find src/Tests -maxdepth 2 -type f -name 'Project.*Service*.Tests.csproj' | head -n 1)"
          if [ -z "$SERVICE_TESTS_PROJECT" ]; then
            echo "::error::Не найден csproj сервисных тестов"
            find src/Tests -maxdepth 2 -type f -name '*.csproj'
            exit 1
          fi
          echo "SERVICE_TESTS_PROJECT=$SERVICE_TESTS_PROJECT" >> "$GITHUB_ENV"
          echo "Найден проект: $SERVICE_TESTS_PROJECT"

      - name: Восстановление зависимостей
        run: dotnet restore "$SERVICE_TESTS_PROJECT"

      - name: Сборка тестов сервисов
        run: dotnet build "$SERVICE_TESTS_PROJECT" --configuration Release --no-restore

      - name: Запуск тестов сервисов
        run: >
          dotnet test "$SERVICE_TESTS_PROJECT"
          --configuration Release
          --no-build
          --logger "trx;LogFileName=service-tests.trx"
          --results-directory TestResults
          -- xUnit.ReporterSwitch=allure

      - name: Сбор Allure-результатов (сервисы)
        if: always()
        run: |
          rm -rf ci-allure-results
          mkdir -p ci-allure-results
          found=0
          while IFS= read -r dir; do
            found=1
            echo "Найдена директория Allure: $dir"
            cp -R "$dir"/. ci-allure-results/ || true
          done < <(find . -type d -name allure-results)
          if [ "$found" -eq 0 ]; then
            echo "Allure-результаты не найдены"
          fi
          echo "Файлов собрано: $(find ci-allure-results -type f | wc -l)"

      - name: Загрузка результатов тестов
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-test-results
          path: TestResults/

      - name: Загрузка Allure-результатов (сервисы)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-allure-results
          path: ci-allure-results/
          if-no-files-found: warn

  # ──────────────────────────────────────────────
  # 3. Тесты репозиториев (Testcontainers + Docker)
  # ──────────────────────────────────────────────
  test-repositories:
    name: Тесты репозиториев
    runs-on: ubuntu-latest
    needs: build-backend

    steps:
      - uses: actions/checkout@v4

      - name: Установка .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Поиск проекта репозиторных тестов
        run: |
          REPOSITORY_TESTS_PROJECT="$(find src/Tests -maxdepth 2 -type f -name 'Project.*Repository*.Tests.csproj' | head -n 1)"
          if [ -z "$REPOSITORY_TESTS_PROJECT" ]; then
            echo "::error::Не найден csproj репозиторных тестов"
            find src/Tests -maxdepth 2 -type f -name '*.csproj'
            exit 1
          fi
          echo "REPOSITORY_TESTS_PROJECT=$REPOSITORY_TESTS_PROJECT" >> "$GITHUB_ENV"
          echo "Найден проект: $REPOSITORY_TESTS_PROJECT"

      - name: Восстановление зависимостей
        run: dotnet restore "$REPOSITORY_TESTS_PROJECT"

      - name: Сборка тестов репозиториев
        run: dotnet build "$REPOSITORY_TESTS_PROJECT" --configuration Release --no-restore

      - name: Запуск тестов репозиториев
        run: >
          dotnet test "$REPOSITORY_TESTS_PROJECT"
          --configuration Release
          --no-build
          --logger "trx;LogFileName=repository-tests.trx"
          --results-directory TestResults
          -- xUnit.ReporterSwitch=allure

      - name: Сбор Allure-результатов (репозитории)
        if: always()
        run: |
          rm -rf ci-allure-results
          mkdir -p ci-allure-results
          found=0
          while IFS= read -r dir; do
            found=1
            echo "Найдена директория Allure: $dir"
            cp -R "$dir"/. ci-allure-results/ || true
          done < <(find . -type d -name allure-results)
          if [ "$found" -eq 0 ]; then
            echo "Allure-результаты не найдены"
          fi
          echo "Файлов собрано: $(find ci-allure-results -type f | wc -l)"

      - name: Загрузка результатов тестов
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repository-test-results
          path: TestResults/

      - name: Загрузка Allure-результатов (репозитории)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repository-allure-results
          path: ci-allure-results/
          if-no-files-found: warn

  # ──────────────────────────────────────────────
  # 4. Тесты контроллеров
  # ──────────────────────────────────────────────
  test-controllers:
    name: Тесты контроллеров
    runs-on: ubuntu-latest
    needs: build-backend

    steps:
      - uses: actions/checkout@v4

      - name: Установка .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Поиск проекта контроллерных тестов
        run: |
          CONTROLLER_TESTS_PROJECT="src/Tests/Project.Controller.Tests/Project.Controller.Tests.csproj"
          if [ ! -f "$CONTROLLER_TESTS_PROJECT" ]; then
            CONTROLLER_TESTS_PROJECT="$(find src/Tests -maxdepth 2 -type f -name 'Project.Controller.Tests.csproj' | head -n 1)"
          fi
          if [ -z "$CONTROLLER_TESTS_PROJECT" ]; then
            echo "::error::Не найден csproj контроллерных тестов"
            echo "Содержимое src/Tests:"
            ls -la src/Tests || true
            find src/Tests -maxdepth 2 -type f -name '*.csproj'
            exit 1
          fi
          echo "CONTROLLER_TESTS_PROJECT=$CONTROLLER_TESTS_PROJECT" >> "$GITHUB_ENV"
          echo "Найден проект: $CONTROLLER_TESTS_PROJECT"

      - name: Восстановление зависимостей
        run: dotnet restore "$CONTROLLER_TESTS_PROJECT"

      - name: Сборка тестов контроллеров
        run: dotnet build "$CONTROLLER_TESTS_PROJECT" --configuration Release --no-restore

      - name: Запуск тестов контроллеров
        run: >
          dotnet test "$CONTROLLER_TESTS_PROJECT"
          --configuration Release
          --no-build
          --logger "trx;LogFileName=controller-tests.trx"
          --results-directory TestResults
          -- xUnit.ReporterSwitch=allure

      - name: Сбор Allure-результатов (контроллеры)
        if: always()
        run: |
          rm -rf ci-allure-results
          mkdir -p ci-allure-results
          found=0
          while IFS= read -r dir; do
            found=1
            echo "Найдена директория Allure: $dir"
            cp -R "$dir"/. ci-allure-results/ || true
          done < <(find . -type d -name allure-results)
          if [ "$found" -eq 0 ]; then
            echo "Allure-результаты не найдены"
          fi
          echo "Файлов собрано: $(find ci-allure-results -type f | wc -l)"

      - name: Загрузка результатов тестов
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: controller-test-results
          path: TestResults/

      - name: Загрузка Allure-результатов (контроллеры)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: controller-allure-results
          path: ci-allure-results/
          if-no-files-found: warn

  # ──────────────────────────────────────────────
  # 5. Интеграционные тесты
  # ──────────────────────────────────────────────
  test-integration:
    name: Интеграционные тесты
    runs-on: ubuntu-latest
    needs: [test-services, test-repositories, test-controllers]
    if: always()
    env:
      RUN_INTEGRATION: ${{ needs.test-services.result == 'success' && needs.test-repositories.result == 'success' && needs.test-controllers.result == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Установка .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Восстановление зависимостей
        if: env.RUN_INTEGRATION == 'true'
        run: dotnet restore src/Tests/Project.Integration.Tests/Project.Integration.Tests.csproj

      - name: Сборка integration тестов
        if: env.RUN_INTEGRATION == 'true'
        run: dotnet build src/Tests/Project.Integration.Tests/Project.Integration.Tests.csproj --configuration Release --no-restore

      - name: Запуск integration тестов
        if: env.RUN_INTEGRATION == 'true'
        run: >
          dotnet test src/Tests/Project.Integration.Tests/Project.Integration.Tests.csproj
          --configuration Release
          --no-build
          --logger "trx;LogFileName=integration-tests.trx"
          --results-directory TestResults
          -- xUnit.ReporterSwitch=allure

      - name: Synthetic skipped для integration (если upstream упал)
        if: env.RUN_INTEGRATION != 'true'
        run: |
          dotnet test src/Tests/Project.Integration.Tests/Project.Integration.Tests.csproj \
            --configuration Release \
            --list-tests \
            --verbosity quiet > integration-tests-list.txt || true
          mkdir -p ci-allure-results
          python3 - <<'PY'
          import json
          import uuid

          tests = []
          with open("integration-tests-list.txt", "r", encoding="utf-8", errors="ignore") as f:
              for line in f:
                  if line.startswith("    "):
                      name = line.strip()
                      if name:
                          tests.append(name)

          if not tests:
              tests = ["Integration tests"]

          for i, test_name in enumerate(tests, start=1):
              payload = {
                  "uuid": str(uuid.uuid4()),
                  "name": test_name.split(".")[-1],
                  "fullName": test_name,
                  "status": "skipped",
                  "statusDetails": {
                      "message": "Integration tests were skipped because required upstream jobs failed."
                  },
                  "stage": "finished",
                  "labels": [
                      {"name": "framework", "value": "xunit"},
                      {"name": "language", "value": "csharp"},
                      {"name": "parentSuite", "value": "CI"},
                      {"name": "suite", "value": "Integration"},
                      {"name": "host", "value": "github-actions"}
                  ]
              }
              with open(f"ci-allure-results/integration-skipped-{i}-result.json", "w", encoding="utf-8") as out:
                  json.dump(payload, out)
          PY

      - name: Пометить integration job как failed (upstream упал)
        if: env.RUN_INTEGRATION != 'true'
        run: |
          echo "::error::Integration tests were skipped because required upstream jobs failed."
          exit 1

      - name: Сбор Allure-результатов (integration)
        if: always() && env.RUN_INTEGRATION == 'true'
        run: |
          rm -rf ci-allure-results
          mkdir -p ci-allure-results
          found=0
          while IFS= read -r dir; do
            found=1
            echo "Найдена директория Allure: $dir"
            cp -R "$dir"/. ci-allure-results/ || true
          done < <(find . -type d -name allure-results)
          if [ "$found" -eq 0 ]; then
            echo "Allure-результаты не найдены"
          fi
          echo "Файлов собрано: $(find ci-allure-results -type f | wc -l)"

      - name: Загрузка результатов integration тестов
        if: always() && env.RUN_INTEGRATION == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: TestResults/

      - name: Загрузка Allure-результатов (integration)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-allure-results
          path: ci-allure-results/
          if-no-files-found: warn

  # ──────────────────────────────────────────────
  # 6. E2E тесты
  # ──────────────────────────────────────────────
  test-e2e:
    name: E2E тесты
    runs-on: ubuntu-latest
    needs: [test-services, test-repositories, test-controllers, test-integration]
    if: always()
    env:
      RUN_E2E: ${{ needs.test-services.result == 'success' && needs.test-repositories.result == 'success' && needs.test-controllers.result == 'success' && needs.test-integration.result == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Установка .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Восстановление зависимостей
        if: env.RUN_E2E == 'true'
        run: dotnet restore src/Tests/Project.E2E.Tests/Project.E2E.Tests.csproj

      - name: Сборка e2e тестов
        if: env.RUN_E2E == 'true'
        run: dotnet build src/Tests/Project.E2E.Tests/Project.E2E.Tests.csproj --configuration Release --no-restore

      - name: Запуск e2e тестов
        if: env.RUN_E2E == 'true'
        run: >
          dotnet test src/Tests/Project.E2E.Tests/Project.E2E.Tests.csproj
          --configuration Release
          --no-build
          --logger "trx;LogFileName=e2e-tests.trx"
          --results-directory TestResults
          -- xUnit.ReporterSwitch=allure

      - name: Synthetic skipped для e2e (если integration не прошел)
        if: env.RUN_E2E != 'true'
        run: |
          dotnet test src/Tests/Project.E2E.Tests/Project.E2E.Tests.csproj \
            --configuration Release \
            --list-tests \
            --verbosity quiet > e2e-tests-list.txt || true
          mkdir -p ci-allure-results
          python3 - <<'PY'
          import json
          import uuid

          tests = []
          with open("e2e-tests-list.txt", "r", encoding="utf-8", errors="ignore") as f:
              for line in f:
                  if line.startswith("    "):
                      name = line.strip()
                      if name:
                          tests.append(name)

          if not tests:
              tests = ["E2E tests"]

          for i, test_name in enumerate(tests, start=1):
              payload = {
                  "uuid": str(uuid.uuid4()),
                  "name": test_name.split(".")[-1],
                  "fullName": test_name,
                  "status": "skipped",
                  "statusDetails": {
                      "message": "E2E tests were skipped because integration stage did not succeed."
                  },
                  "stage": "finished",
                  "labels": [
                      {"name": "framework", "value": "xunit"},
                      {"name": "language", "value": "csharp"},
                      {"name": "parentSuite", "value": "CI"},
                      {"name": "suite", "value": "E2E"},
                      {"name": "host", "value": "github-actions"}
                  ]
              }
              with open(f"ci-allure-results/e2e-skipped-{i}-result.json", "w", encoding="utf-8") as out:
                  json.dump(payload, out)
          PY

      - name: Пометить e2e job как failed (upstream упал)
        if: env.RUN_E2E != 'true'
        run: |
          echo "::error::E2E tests were skipped because required upstream jobs did not succeed."
          exit 1

      - name: Сбор Allure-результатов (e2e)
        if: always() && env.RUN_E2E == 'true'
        run: |
          rm -rf ci-allure-results
          mkdir -p ci-allure-results
          found=0
          while IFS= read -r dir; do
            found=1
            echo "Найдена директория Allure: $dir"
            cp -R "$dir"/. ci-allure-results/ || true
          done < <(find . -type d -name allure-results)
          if [ "$found" -eq 0 ]; then
            echo "Allure-результаты не найдены"
          fi
          echo "Файлов собрано: $(find ci-allure-results -type f | wc -l)"

      - name: Загрузка результатов e2e тестов
        if: always() && env.RUN_E2E == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: TestResults/

      - name: Загрузка Allure-результатов (e2e)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-allure-results
          path: ci-allure-results/
          if-no-files-found: warn

  # ──────────────────────────────────────────────
  # 7. Генерация Allure-отчёта
  # ──────────────────────────────────────────────
  allure-report:
    name: Allure-отчёт
    runs-on: ubuntu-latest
    needs: [test-services, test-repositories, test-controllers, test-integration, test-e2e]
    if: always()

    steps:
      - name: Загрузка Allure-результатов (все)
        uses: actions/download-artifact@v4
        with:
          pattern: "*-allure-results"
          path: allure-artifacts
          merge-multiple: false

      - name: Объединение Allure-результатов
        run: |
          mkdir -p merged-allure-results
          while IFS= read -r dir; do
            echo "Добавляю результаты: $dir"
            cp -R "$dir"/. merged-allure-results/ || true
          done < <(find allure-artifacts -type d -name '*allure-results*')
          echo "Итоговых файлов: $(find merged-allure-results -type f | wc -l)"

      - name: Установка Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Установка Allure CLI
        run: |
          curl -sSL -o allure.tgz https://github.com/allure-framework/allure2/releases/download/2.36.0/allure-2.36.0.tgz
          tar -xzf allure.tgz

      - name: Генерация Allure-отчёта
        run: |
          ./allure-2.36.0/bin/allure generate merged-allure-results -o allure-report --clean --single-file

      - name: Загрузка Allure-отчёта
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          if-no-files-found: warn

  # ──────────────────────────────────────────────
  # 8. Сборка фронтенда (Angular)
  # ──────────────────────────────────────────────
  build-frontend:
    name: Сборка фронтенда
    runs-on: ubuntu-latest
    if: false # временно отключено (падает по ресурсам runner)

    steps:
      - uses: actions/checkout@v4

      - name: Установка Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json

      - name: Установка зависимостей
        working-directory: front
        run: npm ci

      - name: Сборка Angular-приложения
        working-directory: front
        run: npm run build

